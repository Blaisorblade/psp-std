#!/usr/bin/env bash
#

uname="$(uname -a)"

runTravis () {
  cat <<EOM
------------------------------------------------------------
-------------------- End Travis Prelude --------------------
------------------------------------------------------------
EOM
  echo "[info] $(date) - downloading ivy artifact bundle to travis"
  $(dirname $0)/get-cache
}
runTests () {
  sbt -no-colors test || exit 1
  echo "[info] $(date) - finished sbt test"
}
mkRegex () { ( IFS="|" && echo "$*" ); }

echo "[info] $uname"
[[ $uname = *testing-worker-* ]] && runTravis  # only download the cache on travis
echo "[info] $(date) - starting sbt test"

# sbt output filter
regex=$(mkRegex \
  '^\[info\] (Resolving|Loading|Updating|Packaging|Done updating|Done packaging)' \
  '[.]bintray[/][.]credentials' \
  're[-]run with [-]unchecked for details' \
  'ignoring option MaxPermSize' \
  'one warning found'
)

runTests |& egrep --line-buffered -v "$regex"
